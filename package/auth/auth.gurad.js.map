{"version":3,"sources":["../src/auth/auth.gurad.ts"],"names":[],"mappings":";;;;;;;;AAAA,2CAA2E;AAC3E,6CAAsD;AAEtD,8CAAsD;AAKtD,IAAa,SAAS,GAAtB,MAAa,SAAS;IAClB,KAAK,CAAC,WAAW,CAAC,OAAyB;QACvC,MAAM,MAAM,GAAG,6BAAmB,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC;QAEnD,MAAM,IAAI,GAAS,MAAM,CAAC,UAAU,EAAE,CAAC,IAAI,CAAC;QAE5C,IAAI,IAAI,IAAI,IAAI,CAAC,QAAQ,KAAK,QAAQ;YAAE,OAAO,IAAI,CAAC;QAEpD,MAAM,QAAQ,GAAa,EAAE,CAAC;QAC9B,IAAI,IAAI,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE;YAC9B,IAAI,CAAC,WAAW,CAAC,OAAO,CAAC,UAAU,CAAC,EAAE;gBAClC,QAAQ,CAAC,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC;YACvC,CAAC,CAAC,CAAC;QACP,CAAC,CAAC,CAAC;QACH,MAAM,WAAW,GAAe,OAAO,CAAC,WAAW,CAAC,kCAAqB,EAAE,OAAO,CAAC,QAAQ,EAAE,CAAC,SAAS,EAAE,OAAO,CAAC,UAAU,EAAE,CAAC,IAAI,CAAC,CAAC;QACpI,IAAI,WAAW,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,WAAW,CAAC,QAAQ,CAAC,EAAE;YACzD,OAAO,KAAK,CAAC;SAChB;QACD,OAAO,IAAI,CAAC;IAChB,CAAC;CACJ,CAAA;AApBY,SAAS;IADrB,mBAAU,EAAE;GACA,SAAS,CAoBrB;AApBY,8BAAS","file":"auth.gurad.js","sourcesContent":["import { CanActivate, ExecutionContext, Injectable } from '@nestjs/common';\nimport { GqlExecutionContext } from '@nestjs/graphql';\n\nimport { PERMISSION_DEFINITION } from '../decorators';\nimport { Permission } from '../entities/permission.entity';\nimport { User } from '../entities/user.entity';\n\n@Injectable()\nexport class AuthGurad implements CanActivate {\n    async canActivate(context: ExecutionContext): Promise<boolean> {\n        const gqlCtx = GqlExecutionContext.create(context);\n\n        const user: User = gqlCtx.getContext().user;\n\n        if (user && user.username === 'sadmin') return true;\n\n        const userPerm: string[] = [];\n        user && user.roles.forEach(role => {\n            role.permissions.forEach(permission => {\n                userPerm.push(permission.identify);\n            });\n        });\n        const handlerPerm = <Permission>Reflect.getMetadata(PERMISSION_DEFINITION, context.getClass().prototype, context.getHandler().name);\n        if (handlerPerm && !userPerm.includes(handlerPerm.identify)) {\n            return false;\n        }\n        return true;\n    }\n}"]}