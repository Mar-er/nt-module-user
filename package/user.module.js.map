{"version":3,"sources":["../src/user.module.ts"],"names":[],"mappings":"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","file":"user.module.js","sourcesContent":["import { DynamicModule, Global, Inject, Module, OnModuleInit } from '@nestjs/common';\nimport { APP_GUARD } from '@nestjs/core';\nimport { ModulesContainer } from '@nestjs/core/injector/modules-container';\nimport { MetadataScanner } from '@nestjs/core/metadata-scanner';\nimport { InjectRepository, TypeOrmModule } from '@nestjs/typeorm';\nimport { SmsModule } from '@notadd/addon-sms';\nimport { existsSync, mkdirSync, readFileSync, writeFileSync } from 'fs';\nimport { __ as t, configure as i18nConfigure } from 'i18n';\nimport { join } from 'path';\nimport { In, Not, Repository } from 'typeorm';\n\nimport { AuthGuard } from './auth/auth.guard';\nimport { AuthService } from './auth/auth.service';\nimport { AUTH_TOKEN_WHITE_LIST } from './constants/auth.constant';\nimport { PERMISSION_DEFINITION, RESOURCE_DEFINITION } from './decorators';\nimport { InfoGroup } from './entities/info-group.entity';\nimport { InfoItem } from './entities/info-item.entity';\nimport { Organization } from './entities/organization.entity';\nimport { Permission } from './entities/permission.entity';\nimport { Resource } from './entities/resource.entity';\nimport { Role } from './entities/role.entity';\nimport { SystemModule } from './entities/system-module.entity';\nimport { UserInfo } from './entities/user-info.entity';\nimport { User } from './entities/user.entity';\nimport { InfoGroupResolver } from './resolvers/info-group.resolver';\nimport { InfoItemResolver } from './resolvers/info-item.resolver';\nimport { OrganizationResolver } from './resolvers/organization.resolver';\nimport { ResourceResolver } from './resolvers/resource.resolver';\nimport { RoleResolver } from './resolvers/role.resolver';\nimport { SystemModuleResolver } from './resolvers/system-module.resolver';\nimport { UserResolver } from './resolvers/user.resolver';\nimport { EntityCheckService } from './services/entity-check.service';\nimport { InfoGroupService } from './services/info-group.service';\nimport { InfoItemService } from './services/info-item.service';\nimport { OrganizationService } from './services/organization.service';\nimport { ResourceService } from './services/resource.service';\nimport { RoleService } from './services/role.service';\nimport { SystemModuleService } from './services/system-module.service';\nimport { UserService } from './services/user.service';\nimport { CryptoUtil } from './utils/crypto.util';\n\n@Global()\n@Module({\n    imports: [\n        TypeOrmModule.forFeature([Organization, User, Role, SystemModule, Resource, Permission, InfoGroup, InfoItem, UserInfo]),\n        SmsModule\n    ],\n    controllers: [],\n    providers: [\n        { provide: APP_GUARD, useClass: AuthGuard },\n        AuthService,\n        EntityCheckService,\n        OrganizationResolver, OrganizationService,\n        UserResolver, UserService,\n        RoleResolver, RoleService,\n        SystemModuleResolver, SystemModuleService,\n        ResourceResolver, ResourceService,\n        InfoGroupResolver, InfoGroupService,\n        InfoItemResolver, InfoItemService,\n        CryptoUtil\n    ],\n    exports: [AuthService, OrganizationService, UserService, RoleService, InfoGroupService, InfoItemService]\n})\nexport class UserModule implements OnModuleInit {\n    private readonly metadataScanner: MetadataScanner;\n\n    constructor(\n        @Inject(UserService) private readonly userService: UserService,\n        @Inject(ModulesContainer) private readonly modulesContainer: ModulesContainer,\n        @InjectRepository(SystemModule) private readonly systemModuleRepo: Repository<SystemModule>,\n        @InjectRepository(Resource) private readonly resourceRepo: Repository<Resource>,\n        @InjectRepository(Permission) private readonly permissionRepo: Repository<Permission>,\n        @InjectRepository(Role) private readonly roleRepo: Repository<Role>,\n        @InjectRepository(InfoGroup) private readonly infoGroupRepo: Repository<InfoGroup>,\n        @InjectRepository(User) private readonly userRepo: Repository<User>\n    ) {\n        this.metadataScanner = new MetadataScanner();\n    }\n\n    static forRoot(options: { i18n: 'en-US' | 'zh-CN', authTokenWhiteList?: string[] }): DynamicModule {\n        if (!existsSync('src/i18n')) {\n            mkdirSync(join('src/i18n'));\n            writeFileSync(join('src/i18n', 'zh-CN.json'), readFileSync(__dirname + '/i18n/zh-CN.json'));\n            writeFileSync(join('src/i18n', 'en-US.json'), readFileSync(__dirname + '/i18n/en-US.json'));\n        }\n        i18nConfigure({\n            locales: ['en-US', 'zh-CN'],\n            defaultLocale: options.i18n,\n            directory: 'src/i18n'\n        });\n        if (options.authTokenWhiteList) {\n            options.authTokenWhiteList.push(...['IntrospectionQuery', 'login', 'adminLogin', 'register']);\n        } else {\n            options.authTokenWhiteList = ['IntrospectionQuery', 'login', 'adminLogin', 'register'];\n        }\n        return {\n            providers: [{ provide: AUTH_TOKEN_WHITE_LIST, useValue: options.authTokenWhiteList }],\n            module: UserModule\n        };\n    }\n\n    async onModuleInit() {\n        await this.loadResourcesAndPermissions();\n        await this.createDefaultRole();\n        await this.createDefaultInfoGroup();\n        await this.createSuperAdmin();\n    }\n\n    /**\n     * Load resources, permission annotations, and save them to the database\n     */\n    private async loadResourcesAndPermissions() {\n        const metadataMap: Map<string, { name: string, resource: Resource[] }> = new Map();\n        this.modulesContainer.forEach((moduleValue, moduleKey) => {\n            for (const [componentKey, componentKeyValue] of [...moduleValue.components, ...moduleValue.routes]) {\n                const isResolverOrController =\n                    Reflect.getMetadataKeys(componentKeyValue.instance.constructor)\n                        .filter(key => ['graphql:resolver_type', 'path']\n                            .includes(key)).length > 0;\n\n                if (isResolverOrController) {\n                    const resource: Resource = Reflect.getMetadata(RESOURCE_DEFINITION, componentKeyValue.instance.constructor);\n                    const prototype = Object.getPrototypeOf(componentKeyValue.instance);\n\n                    if (resource && prototype) {\n                        const permissions: Permission[] = this.metadataScanner.scanFromPrototype(componentKeyValue.instance, prototype, name => {\n                            return Reflect.getMetadata(PERMISSION_DEFINITION, componentKeyValue.instance, name);\n                        });\n                        resource.permissions = permissions;\n\n                        if (metadataMap.has(moduleKey)) {\n                            metadataMap.get(moduleKey).name = t(moduleValue.metatype.name);\n                            metadataMap.get(moduleKey).resource.push(resource);\n                        } else {\n                            metadataMap.set(moduleKey, { name: t(moduleValue.metatype.name), resource: [resource] });\n                        }\n                    }\n                }\n            }\n        });\n\n        metadataMap.forEach(value => {\n            value.resource.forEach(resource => {\n                resource.name = t(resource.name);\n                resource.permissions.forEach(p => p.name = t(p.name));\n            });\n        });\n\n        // Sacnned modules\n        const scannedModules = [...metadataMap.values()].map(v => ({ name: v.name }));\n\n        // Delete removed module\n        const notExistingModule = await this.systemModuleRepo.find({\n            where: { name: Not(In(scannedModules.length ? scannedModules.map(v => v.name) : ['__delete_all_system_module__'])) }\n        });\n        if (notExistingModule.length) await this.systemModuleRepo.delete(notExistingModule.map(v => v.id));\n        // Create new module\n        const existingModules = await this.systemModuleRepo.find({ order: { id: 'ASC' } });\n        const newModules = scannedModules.filter(sm => !existingModules.map(v => v.name).includes(sm.name));\n        if (newModules.length) await this.systemModuleRepo.save(this.systemModuleRepo.create(newModules));\n        // Update existing module\n        if (existingModules.length) {\n            existingModules.forEach(em => {\n                em.name = scannedModules.find(sm => sm.name === em.name).name;\n            });\n            await this.systemModuleRepo.save(existingModules);\n        }\n\n        // Sacnned resources\n        for (const [key, value] of metadataMap) {\n            const resourceModule = await this.systemModuleRepo.findOne({ where: { name: value.name } });\n            value.resource.forEach(async resouece => {\n                resouece.systemModule = resourceModule;\n            });\n        }\n        const scannedResources: Resource[] = <Resource[]>[].concat(...[...metadataMap.values()].map(v => v.resource));\n\n        // Delete removed resource\n        const resourceIdentifies = scannedResources.length ? scannedResources.map(v => v.identify) : ['__delete_all_resource__'];\n        const notExistResources = await this.resourceRepo.find({ where: { identify: Not(In(resourceIdentifies)) } });\n        if (notExistResources.length > 0) await this.resourceRepo.delete(notExistResources.map(v => v.id));\n        // Create new resource\n        const existResources = await this.resourceRepo.find({ order: { id: 'ASC' } });\n        const newResourcess = scannedResources.filter(sr => !existResources.map(v => v.identify).includes(sr.identify));\n        if (newResourcess.length > 0) await this.resourceRepo.save(this.resourceRepo.create(newResourcess));\n        // Update resource\n        if (existResources.length) {\n            existResources.forEach(er => {\n                er.name = scannedResources.find(sr => sr.identify === er.identify).name;\n            });\n            await this.resourceRepo.save(existResources);\n        }\n\n        // Sacnned permissions\n        const scannedPermissions = <Permission[]>[].concat(...scannedResources.map(metadataValue => {\n            metadataValue.permissions.forEach(v => v.resource = metadataValue);\n            return metadataValue.permissions;\n        }));\n        // Delete removed permission\n        const resource = await this.resourceRepo.find({ where: { identify: In(scannedPermissions.map(v => v.resource.identify)) } });\n        scannedPermissions.forEach(permission => {\n            permission.resource = resource.find(v => v.identify === permission.resource.identify);\n        });\n        // Create removed permission\n        const permissionIdentifies = scannedPermissions.length ? scannedPermissions.map(v => v.identify) : ['__delete_all_permission__'];\n        const notExistPermissions = await this.permissionRepo.find({ where: { identify: Not(In(permissionIdentifies)) } });\n        if (notExistPermissions.length > 0) await this.permissionRepo.delete(notExistPermissions.map(v => v.id));\n\n        const existPermissions = await this.permissionRepo.find({ order: { id: 'ASC' } });\n        const newPermissions = scannedPermissions.filter(sp => !existPermissions.map(v => v.identify).includes(sp.identify));\n        if (newPermissions.length > 0) await this.permissionRepo.save(this.permissionRepo.create(newPermissions));\n        // Update permission\n        if (existPermissions.length) {\n            existPermissions.forEach(ep => {\n                ep.name = scannedPermissions.find(sp => sp.identify === ep.identify).name;\n                ep.action = scannedPermissions.find(sp => sp.identify === ep.identify).action;\n            });\n            await this.permissionRepo.save(existPermissions);\n        }\n    }\n\n    /**\n     * Create a default ordinary user role\n     */\n    private async createDefaultRole() {\n        const defaultRole = await this.roleRepo.findOne(1);\n\n        if (defaultRole) return;\n\n        await this.roleRepo.save(this.roleRepo.create({\n            id: 1,\n            name: t('ordinary user')\n        }));\n    }\n\n    /**\n     * Create a default information group\n     */\n    private async createDefaultInfoGroup() {\n        const defaultInfoGroup = await this.infoGroupRepo.findOne(1);\n\n        if (defaultInfoGroup) return;\n\n        await this.infoGroupRepo.save(this.infoGroupRepo.create({\n            id: 1,\n            name: t('ordinary user information group'),\n            role: {\n                id: 1\n            }\n        }));\n    }\n\n    /**\n     * Create a system super administrator\n     */\n    private async createSuperAdmin() {\n        const sadmin = await this.userRepo.findOne({ where: { username: 'sadmin' } });\n        if (sadmin) return;\n        await this.userService.createUser({ username: 'sadmin', password: 'sadmin' });\n    }\n}"]}